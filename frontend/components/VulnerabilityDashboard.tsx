
import React, { useState, useMemo } from 'react';
import { X, ShieldAlert, AlertTriangle, Info, Filter, ArrowUpDown, Search, Laptop } from 'lucide-react';
import { Node, Vulnerability } from '../types';

interface VulnerabilityDashboardProps {
  nodes: Node[];
  onClose: () => void;
}

interface FlattenedVuln extends Vulnerability {
  nodeId: string;
  nodeLabel: string;
  nodeIp: string;
  nodeStatus: string;
}

export const VulnerabilityDashboard: React.FC<VulnerabilityDashboardProps> = ({ nodes, onClose }) => {
  const [filterSeverity, setFilterSeverity] = useState<string>('all');
  const [filterDevice, setFilterDevice] = useState<string>('');
  const [sortBy, setSortBy] = useState<'severity' | 'cvss' | 'device'>('severity');

  const allVulnerabilities = useMemo(() => {
    const list: FlattenedVuln[] = [];
    nodes.forEach(node => {
      if (node.detailedVulnerabilities) {
        node.detailedVulnerabilities.forEach(vuln => {
          list.push({
            ...vuln,
            nodeId: node.id,
            nodeLabel: node.label,
            nodeIp: node.ip,
            nodeStatus: node.status
          });
        });
      }
    });
    return list;
  }, [nodes]);

  const filteredAndSorted = useMemo(() => {
    let result = [...allVulnerabilities];

    // Filtering
    if (filterSeverity !== 'all') {
      result = result.filter(v => v.severity.toLowerCase() === filterSeverity.toLowerCase());
    }
    
    if (filterDevice.trim() !== '') {
      const q = filterDevice.toLowerCase();
      result = result.filter(v => 
        v.nodeLabel.toLowerCase().includes(q) || 
        v.nodeIp.includes(q)
      );
    }

    // Sorting
    result.sort((a, b) => {
      if (sortBy === 'cvss') {
        return b.cvss - a.cvss;
      }
      if (sortBy === 'severity') {
        const priority: Record<string, number> = { critical: 4, high: 3, medium: 2, low: 1 };
        return (priority[b.severity.toLowerCase()] || 0) - (priority[a.severity.toLowerCase()] || 0);
      }
      if (sortBy === 'device') {
        return a.nodeLabel.localeCompare(b.nodeLabel);
      }
      return 0;
    });

    return result;
  }, [allVulnerabilities, filterSeverity, filterDevice, sortBy]);

  const getSeverityBadge = (severity: string) => {
    switch(severity.toLowerCase()) {
      case 'critical': return 'bg-red-500 text-white border-red-400';
      case 'high': return 'bg-orange-500 text-white border-orange-400';
      case 'medium': return 'bg-yellow-500 text-black border-yellow-400';
      case 'low': return 'bg-blue-500 text-white border-blue-400';
      default: return 'bg-slate-500 text-white border-slate-400';
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-10 animate-in fade-in duration-200">
      <div className="flex h-full w-full max-w-6xl flex-col overflow-hidden rounded-lg border border-white/10 bg-[#0a0a0a] shadow-2xl">
        
        {/* Header */}
        <div className="flex items-center justify-between border-b border-white/10 bg-black/40 px-6 py-4">
          <div className="flex items-center gap-3">
             <div className="flex h-10 w-10 items-center justify-center rounded bg-red-500/20 text-red-500">
                <ShieldAlert size={20} />
             </div>
             <div>
               <h2 className="text-xl font-bold text-white uppercase tracking-tight">Global Vulnerability Report</h2>
               <p className="text-xs text-slate-400 font-mono">
                 {allVulnerabilities.length} Issues Detected Across {nodes.length} Assets
               </p>
             </div>
          </div>
          <button onClick={onClose} className="rounded-full p-2 text-slate-500 hover:bg-white/10 hover:text-white transition-colors">
             <X size={24} />
          </button>
        </div>

        {/* Toolbar */}
        <div className="flex flex-wrap items-center gap-4 border-b border-white/10 bg-white/5 px-6 py-3">
          
          <div className="flex items-center gap-2">
            <Filter size={14} className="text-slate-400" />
            <span className="text-[10px] font-bold uppercase tracking-widest text-slate-500">Severity:</span>
            <select 
              className="rounded border border-white/10 bg-black px-3 py-1.5 text-xs text-white focus:border-cyan-500 outline-none"
              value={filterSeverity}
              onChange={(e) => setFilterSeverity(e.target.value)}
            >
              <option value="all">ALL LEVELS</option>
              <option value="critical">CRITICAL</option>
              <option value="high">HIGH</option>
              <option value="medium">MEDIUM</option>
              <option value="low">LOW</option>
            </select>
          </div>

          <div className="flex items-center gap-2">
            <ArrowUpDown size={14} className="text-slate-400" />
            <span className="text-[10px] font-bold uppercase tracking-widest text-slate-500">Sort By:</span>
            <div className="flex rounded bg-black/50 p-1 border border-white/10">
               {(['severity', 'cvss', 'device'] as const).map(opt => (
                 <button
                   key={opt}
                   onClick={() => setSortBy(opt)}
                   className={`px-3 py-1 rounded text-[10px] font-bold uppercase transition-colors ${sortBy === opt ? 'bg-cyan-600 text-white' : 'text-slate-500 hover:text-slate-300'}`}
                 >
                   {opt}
                 </button>
               ))}
            </div>
          </div>

          <div className="ml-auto flex items-center gap-2 relative">
             <Search size={14} className="absolute left-3 text-slate-500" />
             <input 
               type="text" 
               placeholder="Search device or IP..." 
               className="w-64 rounded-full border border-white/10 bg-black py-1.5 pl-9 pr-4 text-xs text-white focus:border-cyan-500 outline-none placeholder:text-slate-600"
               value={filterDevice}
               onChange={(e) => setFilterDevice(e.target.value)}
             />
          </div>
        </div>

        {/* List Content */}
        <div className="flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent">
          {filteredAndSorted.length === 0 ? (
            <div className="flex h-full flex-col items-center justify-center text-slate-500">
               <ShieldAlert size={48} className="mb-4 opacity-20" />
               <p className="text-sm font-bold uppercase tracking-widest">No matching vulnerabilities found</p>
            </div>
          ) : (
            <div className="grid gap-3">
              {filteredAndSorted.map((vuln, idx) => (
                <div key={idx} className="flex items-start gap-4 rounded border border-white/5 bg-white/5 p-4 transition-colors hover:bg-white/10">
                   {/* Severity Score Box */}
                   <div className="flex flex-col items-center justify-center w-16 shrink-0 gap-1">
                      <div className={`flex h-10 w-10 items-center justify-center rounded-lg border text-sm font-bold shadow-lg ${getSeverityBadge(vuln.severity)}`}>
                        {vuln.cvss}
                      </div>
                      <span className="text-[8px] font-black uppercase tracking-widest text-slate-500">CVSS</span>
                   </div>

                   {/* Main Info */}
                   <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-3 mb-1">
                         <h3 className="text-sm font-bold text-white font-mono">{vuln.cve}</h3>
                         <span className={`px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wider border ${getSeverityBadge(vuln.severity)} bg-opacity-20`}>
                           {vuln.severity}
                         </span>
                      </div>
                      <p className="text-xs text-slate-300 mb-2 leading-relaxed">
                        {vuln.description}
                      </p>
                      
                      {/* Meta Footer */}
                      <div className="flex items-center gap-6 border-t border-white/5 pt-2 mt-2">
                         <div className="flex items-center gap-2 text-cyan-400">
                            <Laptop size={12} />
                            <span className="text-xs font-bold">{vuln.nodeLabel}</span>
                            <span className="text-[10px] font-mono text-slate-500 bg-black/30 px-1 rounded">{vuln.nodeIp}</span>
                         </div>
                         <div className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">
                            Status: <span className={vuln.nodeStatus === 'compromised' ? 'text-red-500' : 'text-emerald-500'}>{vuln.nodeStatus}</span>
                         </div>
                      </div>
                   </div>
                </div>
              ))}
            </div>
          )}
        </div>

      </div>
    </div>
  );
};
