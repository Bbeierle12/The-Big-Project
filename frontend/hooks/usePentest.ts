
import React, { useState, useEffect } from 'react';
import { Node } from '../types';
import { NetWatchApi } from '../services/api';
import { inferSubnetTarget } from '../utils/networkUtils';

export const usePentest = (
  nodes: Node[]
) => {
  const [logs, setLogs] = useState<string[]>([]);

  useEffect(() => {
    // Listen for alert events from tools
    const handleAlert = (alert: any) => {
      addOutput(`[!] ALERT: ${alert.title} (${alert.severity})`);
      if (alert.severity === 'critical') {
         addLog(`System Compromise Detected on ${alert.device_ip}`);
      }
    };
    NetWatchApi.on('alert.created', handleAlert);
    return () => NetWatchApi.off('alert.created', handleAlert);
  }, []);

  const addLog = (cmd: string) => {
    setLogs(prev => {
      const newLogs = [...prev, `root@kali:~# ${cmd}`];
      return newLogs.length > 8 ? newLogs.slice(newLogs.length - 8) : newLogs;
    });
  };

  const addOutput = (output: string) => {
     setLogs(prev => {
        const newLogs = [...prev, output];
        return newLogs.length > 8 ? newLogs.slice(newLogs.length - 8) : newLogs;
     });
  };

  const executeCommand = async (tool: string, selectedIds: string[]) => {
    // Parse tool:task format (e.g., "nmap:port_scan")
    const [toolName, taskName] = tool.includes(':') ? tool.split(':') : [tool, 'scan'];

    if (selectedIds.length === 0) {
      addLog(`${toolName} --help`);
      addOutput(`Error: No target specified. Select a node first.`);
      return;
    }

    // For nmap scans, use the scan API with proper task
    if (toolName === 'nmap') {
      try {
        const targetIps = nodes
          .filter(n => selectedIds.includes(n.id) && !!n.ip)
          .map(n => n.ip);
        const target = targetIps.length > 0 ? targetIps.join(' ') : inferSubnetTarget(nodes);
        addLog(`nmap ${taskName === 'quick_scan' ? '-sn' : taskName === 'port_scan' ? '-sS' : taskName === 'os_detect' ? '-O' : taskName === 'service_detect' ? '-sV' : taskName === 'vuln_scan' ? '--script vuln' : '-A'} ${target}`);

        const result = await NetWatchApi.launchScan({
          scan_type: taskName === 'vuln_scan' ? 'vulnerability' : 'network',
          tool: 'nmap',
          target,
          parameters: { task: taskName }
        });

        addOutput(`[+] Scan ${result.id.slice(0, 8)} started`);
        if (result.status === 'completed') {
          addOutput(`[+] Found ${result.devices_found || 0} hosts`);
          if (result.result_summary) {
            addOutput(`[+] ${result.result_summary}`);
          }
        }
        return;
      } catch (e: any) {
        addOutput(`[!] Scan failed: ${e.message || e}`);
        return;
      }
    }

    // For other tools, use the execute API
    try {
      const targets = selectedIds.join(',');
      addLog(`${toolName} -T ${targets}`);

      const result = await NetWatchApi.executeTool(toolName, taskName, { target_ids: selectedIds });
      addOutput(`[+] Tool ${toolName} execution completed`);
      if (result.result) {
        addOutput(`[+] Result: ${JSON.stringify(result.result).slice(0, 100)}...`);
      }

    } catch (e: any) {
      addOutput(`[!] Tool ${toolName} failed: ${e?.message || e}`);
    }
  };

  return { logs, executeCommand };
};
